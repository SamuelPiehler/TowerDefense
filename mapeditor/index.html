<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <script src=req/save.js>
   </script> 
   <script src="req/jszipmin.js"> </script>
  <style>
    @import url("../css/maps.css") screen; </style>  <script src = "req/html2canvas.js" >
    </script>

  <script type="text/javascript">
    /************************************************************************************************************
    (C) www.dhtmlgoodies.com, October 2005
    
    This is a script from www.dhtmlgoodies.com. You will find this and a lot of other scripts at our website.	
    
    Terms of use:
    You are free to use this script as long as the copyright message is kept intact. However, you may not
    redistribute, sell or repost it without our permission.
    
    Thank you!
    
    www.dhtmlgoodies.com
    Alf Magne Kalleland
    
    ************************************************************************************************************/
    function getScreenshotOfElement(element, posX, posY, width, height, callback) {
      window.scrollTo(0, 0);
      html2canvas(element, {

        width: width,
        height: height,
        useCORS: true,
        taintTest: false,
        allowTaint: false
      }).then(function (canvas) {
        callback(canvas.toDataURL().replace("data:image/png;base64,", ""));
      });
    }
  </script>
</head>

<body>
  <div id=information>
    <div id="randomrotation">
      <lable>
        Zufällige Drehung vom Hintergrund?
        <input type=checkbox onclick="settings.randomtiles = this.checked;" id=rando>
      </lable>
      <br>
      <br>
      <lable>
        wie sollen mehrere StartPunkte <br> behandelt werden?
        <select onchange="changesetting(this);">
          <option>
            Alle Abwechselnd?
          </option>
          <option>
            Alle Zufällig?
          </option>
          <option>
            Alle Auf einmal?
          </option>
        </select>
      </lable>
    </div>
    <div class="infoopacity">
      <lable class=slide>
        <div id=text>Startgeld der Map</div>
        <div id=valb></div>
        <div class=s> 75
          <input id=sliding oninput="settings.geld=this.value; document.getElementById('valb').innerHTML= this.value;"
            type="range" min="50" max="200" value="75" step="1">
          200 </div>
      </lable>
    </div>
    <div class="infoopacity">
      <lable class=slide>
        <div id=text>Sichtbarkeit der Pfeile im Bild</div>
        <div id=val></div>
        <div class=s> 0
          <input id=slider type="range" min="0" max="1" value=1 step="0.01">
          1 </div>
      </lable>
    </div>
    <div class="infoopacity">
      <lable>
        <div id=text>Map als Vorlage Exportieren</div>
        <input type="button" onclick="exportmap();" value="Exportieren!">
        <button onclick="exportmap(true)" id="asdf">als Datei herunterladen</button>
        <input id=filename type=filename placeholder="Dateiname?">
      </lable>
    </div>
    <div class="infoopacity">
      <lable>
        <div id=text>Map als js format herunterladen</div>
        <input type="button" onclick="generatemapstring();" value="Map.js herunterladen!">
      </lable>
    </div>
    <div class="infoopacity">
      <lable>
        <div id=text>Mapfile hochladen</div>
        <p><input type="file" id="dateien" name="files[]" multiple=""></p>
        <output id="dateiListe"></output>
        <button onclick="importmap(true)" id="asdf">File hochladen</button>
      </lable>
    </div>
    <div class="infoopacity" id="zusatz">
      <lable>
        <div id=text>Zusätze</div>
        <input type="text" id="mapname" placeholder="Mapnamen Eingeben">
        Mapschwierigkeit einschatzen und auswählen
        <select id="diffiin">
          <option>
            sehr-leicht
          </option>
          <option>
            Einfach
          </option>
          <option>
            Mittel
          </option>
          <option>
            Schwer
          </option>
          <option>
            Sehr Schwer
          </option>
        </select>
        <button onclick="updateextra();" id="asdf">Abschicken</button>
      </lable>
    </div>
  </div>
  <div id=buttons>

  </div>
  <div id=area>
    <div class=feld>

    </div>
  </div>
  <div id=inwrap>
    <div class=inventory>
      <div class=intile>
        <div class="inimage selected" id="1" invno="0">
          <img src="../Bilder/Map/feld1.jpg">
          <div class=inlable>
            Leeres Feld/Bau-Feld
          </div>
        </div>
        <div class=floaties>
          <img src="../Bilder/Map/feld1.jpg" class="true">
          <img src="../Bilder/Map/feld2.jpg" class="false">
        </div>
      </div>
      <div class=intile>
        <div class=inimage id="2" invno="1">
          <img width=74 height=74 src="../Bilder/Map/weg1.jpg">
          <div class=inlable>
            Gegner-weg
          </div>
        </div>
        <div class=floaties>
          <img width=74 height=74 src="../Bilder/Map/weg1.jpg" class="false">
          <img width=74 height=74 src="../Bilder/Map/weg2.jpg" class="false">
          <img width=74 height=74 src="../Bilder/Map/weg3.png" class="false">
        </div>
      </div>
      <div class=intile>
        <div class=inimage id="3" invno="-1">
          <img src="../Bilder/Map/stein1.png">
          <div class=inlable>
            Landschaft
          </div>
        </div>
        <div class=floaties>
          <img src="../Bilder/Map/stein1.png" class="false">
          <img src="../Bilder/Map/stein2.png" class="false">
          <img src="../Bilder/Map/stein3.png" class="false">
          <img src="../Bilder/Icons/sandBurg.png" class="false">
          <img src="../Bilder/Icons/welle.png" class="false">
        </div>
      </div>
      <div class=intile>
        <div class=inimage id="4" invno="13">
          <img src="../Bilder/Map/zwischenPortal1.png">
          <div class=inlable>
            Portal_1
          </div>
        </div>
        <div class=floaties>
          <img src="../Bilder/Map/zwischenPortal1.png" class="true">
          <img src="../Bilder/Map/zwischenPortal2.png" class="false">
        </div>
      </div>
      <!--
      <div class=intile>
        <div class=inimage id="5" invno="17">
          <img src="../Bilder/Map/zwischenPortal2.png">
          <div class=inlable>
            Portal_2
          </div>
        </div>
        <div class=floaties>
          <img src="../Bilder/Map/zwischenPortal2.png">
        </div>
      </div> -->
      <div class=intile>
        <div class=inimage id="6" invno="-2">
          <img src="../Bilder/Map/weg1.jpg">
          <div class=inlable>
            Kreuzung
          </div>
        </div>
        <div class=floaties>
          <img width=74 height=74 src="../Bilder/Map/weg1.jpg" class="false">
          <img width=74 height=74 src="../Bilder/Map/weg2.jpg" class="false">
          <img width=74 height=74 src="../Bilder/Map/weg3.png" class="false">
        </div>
      </div>
      <div class=intile>
        <div class=inimage id="7" invno="5">
          <img src="../Bilder/Map/start.png">
          <div class=inlable>
            Start-Feld
          </div>
        </div>
        <div class=floaties>
          <img src="../Bilder/Map/start.png">
        </div>
      </div>
      <div class=intile>
        <div class=inimage id="8" invno="9">
          <img src="../Bilder/Map/ziel1.png">
          <div class=inlable>
            Ziel-Feld
          </div>
        </div>
        <div class=floaties>
          <img src="../Bilder/Map/ziel1.png">
        </div>
      </div>
      <div class=intile>
        <div class=inimage id="9" invno="-1234">
          <img src="../Bilder/Map/feld1.jpg">
          <div class=inlable>
            settings.hintergrund- tool
          </div>
        </div>
        <div class=floaties>
          <img src="../Bilder/Map/feld1.jpg">
          <img src="../Bilder/Map/feld2.jpg">
          <img width=74 height=74 src="../Bilder/Map/weg1.jpg" class="false">
          <img width=74 height=74 src="../Bilder/Map/weg2.jpg" class="false">
          <img width=74 height=74 src="../Bilder/Map/weg3.png" class="false">
        </div>
      </div>
      <div class=intile>
          <div class=inimage asl="aslb" id="9" invno="-1234">
            <img id="from" src="../Bilder/Map/feld1.jpg">
            <div class=inlable>
              Von diesem Aussehen
            </div>
          </div>
          <div class=floaties>
            <img src="../Bilder/Map/feld1.jpg">
            <img src="../Bilder/Map/feld2.jpg">
            <img width=74 height=74 src="../Bilder/Map/weg1.jpg" class="false">
            <img width=74 height=74 src="../Bilder/Map/weg2.jpg" class="false">
            <img width=74 height=74 src="../Bilder/Map/weg3.png" class="false">
          </div>
        </div>
        <div class=intile>
            <div class="inimage" asl="asl" id="9" invno="-1234">
              <img id="to" src="../Bilder/Map/feld1.jpg">
              <div class=inlable>
                Zu diesem hier!!
              </div>
            </div>
            <div class=floaties>
              <img src="../Bilder/Map/feld1.jpg">
              <img src="../Bilder/Map/feld2.jpg">
              <img width=74 height=74 src="../Bilder/Map/weg1.jpg" class="false">
              <img width=74 height=74 src="../Bilder/Map/weg2.jpg" class="false">
              <img width=74 height=74 src="../Bilder/Map/weg3.png" class="false">
            </div>
          </div>
    </div>
  </div>
  <textarea id=output>Hier wird deine datei gezeigt!</textarea>
  <textarea id=input>hier kannst du deine Map-Vorlage laden</textarea>

  <img id="screenshot">
  <script>
    function updateextra() {
      settings.difficulty = document.getElementById("diffiin").selectedIndex;
      settings.Mapname = document.getElementById("mapname").value;
    }
    var dataURL = false;
    var ismaptrue = false;

    function changesetting(el) {
      settings.starthandle = el.selectedIndex;
    }

    function exportmap(safe = false) {
      if (safe) {
        var code = "[" + JSON.stringify(tiles) + "," + JSON.stringify(settings) + "]";
        var blob = new Blob([code], {
          type: "text/plain;charset=utf-8"
        });
        var fn = document.getElementById("filename").value;
        if (fn == "" || fn == undefined) {
          fn = "mapfile" + Math.round(Math.random() * 10000000000);
        }
        saveAs(blob, fn + ".mapfile");
      } else
        document.getElementById("output").value = "[" + JSON.stringify(tiles) + "," + JSON.stringify(settings) + "]";
    }

    function importmap(te) {
      var getfile = false
      if (te === true) {
        if (ismaptrue === true) {
          if (dataURL != false)
            getfile = true;
        }
      }
      var inputted;
      if (getfile)
        inputted = dataURL;
      else
        inputted = document.getElementById("input").value;
      var out = JSON.parse(inputted);
      settings = out[1];
      out = out[0];
      //console.log(out);
      out.forEach((ele) => {
        ele.update = update;
      });

      var id = out[out.length - 1].id;
      var spl = id.split(",");
      generate(spl[1] - -1, spl[0] - -1);
      tiles = out;
      tiles.forEach((el) => {
        el.update("gen");
      })
    }
    var shift = false;
    var settings = {
      pid: 0,
      portalamount: 0,
      nextmove: false,
      starthandle: 0,
      difficulty: false,
      Mapname: false,
      selectedstyle: "",
      portal1: false,
      portal2: false,
      wi: null,
      hei: null,
      randomtiles: false,
      Xkoordinaten: 15,
      Ykoordinaten: 5,
      backchanged: true,
      hintergrund: false,
      selectedinv: 1,
      lastbackground: "../Bilder/Map/feld1.jpg",
      geld: 75,
      mapstring: "",
      imagedata: "",
      lastid: "0",
      clickindex: 0,
      opacity: 1,
    };
    //  var settings.selectedstyle ="";
    //  var settings.portal1 = false;
    //    var settings.portal2 = false;
    //var wi;
    //   var settings.hei;
    //   var settings.randomtiles = false;
    //  var settings.Xkoordinaten=15;
    //   var settings.Ykoordinaten=5;
    //  var settings.backchanged = true;
    //   var settings.hintergrund = false;
    //   var settings.selectedinv = 1;
    //    var settings.lastbackground= "../Bilder/Map/feld1.jpg";
    /* eslint no-//console: ["error", { allow: ["log"] }] */
    /* eslint no-//console: "error" */
    var currentportal = "";
    var map;
    //die schwierigkeit vorbereiten es gibt kein Standart mehr!!
    var schwierigkeit;
    //hier werden alle verfügbaren maps gespeichert
    var maplist = [];
    //wird zum laden der maps benötigt, gibt an, ob alle bisher getesteten maps existiert haben
    var allsucceeded = true;
    var success = false;
    //ist die momentan gesuchte mapnummer ab dieser Zahl beginnt die Suche
    var checkerturn = 1;
    //firstTimeLoad gibt an, ob Daten das erste mal geladen werden müssen;
    var firstTimeLoad = true;
    //backmap ist die momentan geladene karte
    var backmap = "";
    //funktionsaufruf um alle karten anzuzeigen
    //    var settings.geld= 75;
    //    var settings.mapstring= "";
    //    var settings.imagedata = "";
    //    var settings.thismap = [];
    var tiles = [];
    //    var settings.lastid = "0";
    //   var settings.clickindex=0;
    function handle(el, func) {
      //success wird immer beim erfolgre
      if (success) {
        maplist.push([map, settings.geld, checkerturn]);
        checkerturn++;
        map = mapold;
        settings.geld = geldold;
        getmaps(func);
      }
      if (success == false) {
        func(maplist);
        el.remove();
      }
      succcess = false
      map = mapold;
      settings.geld = geldold;

    }

    function update(tile_id, bi) {
//console.log(tile_id,bi);

      if (settings.hintergrund != false) {
        var bottom = document.getElementById("" + this.id + "bottom");
        bottom.src = settings.hintergrund;
        this.hinter = settings.hintergrund.replace(/(http:|https:|[A-Z]:).*\/.*\/(?=Bilder\/.*)/gm, "");;
        settings.hintergrund = false;
      } else {
        if (settings.clickindex > 3) {
          settings.clickindex = 0;
        }

        //console.log(settings.clickindex, bi)
        var doc = document.getElementById(this.id);
        var top = document.getElementById("" + this.id + "top");
        var gotchanged = false;
        var wasbefore = (this.rtile == 13);
        var bild = doc;
        var portal = document.getElementById("info" + this.id);
        if (tile_id >= 1 && tile_id <= 4) {
          if (settings.lastid == this.id)
            settings.clickindex++;
          if (settings.clickindex == 4)
            settings.clickindex = 0;
          //console.log(settings.clickindex)
          bild.src = bi;
          top.src = "../Bilder/Map/pfeil.png";
          rotateIt(top, settings.clickindex * 90);
          this.top = top.src.replace(/(http:|https:|[A-Z]:).*\/.*\/(?=Bilder\/.*)/gm, "");
          this.tile = tile_id + settings.clickindex;
          this.istwo = false;
          gotchanged = true;
        } else if (tile_id >= 5 && tile_id <= 8) {
          if (settings.lastid == this.id)
            settings.clickindex++;
          if (settings.clickindex == 4)
            settings.clickindex = 0;
          bild.src = bi;
          top.src = "../Bilder/Map/startPfeil.png";
          this.top = top.src.replace(/(http:|https:|[A-Z]:).*\/.*\/(?=Bilder\/.*)/gm, "");
          rotateIt(top, settings.clickindex * 90);
          this.istwo = true;
          if (settings.backchanged) {
            var bottom = document.getElementById("" + this.id + "bottom");
            bottom.src = settings.lastbackground;
            this.hinter = settings.lastbackground;
          }
          this.tile = tile_id + settings.clickindex;

          gotchanged = true;
        } else if (tile_id == 9) {
          bild.src = bi;
          top.src = "../Bilder/Map/zielPfeil.png";
          this.top = top.src.replace(/(http:|https:|[A-Z]:).*\/.*\/(?=Bilder\/.*)/gm, "");;
          rotateIt(top, settings.clickindex * 90);
          this.istwo = true;
          if (settings.backchanged) {
            var bottom = document.getElementById("" + this.id + "bottom");
            bottom.src = settings.lastbackground;
            this.hinter = settings.lastbackground;
          }
          this.tile = tile_id;
          gotchanged = true;
        } else if (tile_id == 0) {
          bild.src = bi;
          top.src = "../Bilder/Map/empty.png";
          this.top = top.src.replace(/(http:|https:|[A-Z]:).*\/.*\/(?=Bilder\/.*)/gm, "");;
          this.istwo = false;
          this.tile = 0;
          gotchanged = true;
        } else if (tile_id == -1) {
          bild.src = bi;
          top.src = "../Bilder/Map/empty.png";
          this.top = top.src.replace(/(http:|https:|[A-Z]:).*\/.*\/(?=Bilder\/.*)/gm, "");;
          if (settings.backchanged) {
            var bottom = document.getElementById("" + this.id + "bottom");
            bottom.src = settings.lastbackground;
            this.hinter = settings.lastbackground;
          }
          this.istwo = true;
          this.tile = -1;
          gotchanged = true;
        } else if (tile_id == -2) {
          bild.src = bi;
          top.src = "../Bilder/Map/kreuzung.png";
          this.top = top.src.replace(/(http:|https:|[A-Z]:).*\/.*\/(?=Bilder\/.*)/gm, "");;
          rotateIt(top, settings.clickindex * 90);
          this.tile = -2;
          this.istwo = false;
          gotchanged = true;
        } else if (tile_id >= 13 && tile_id <= 16) {
          if (settings.lastid == this.id)
            settings.clickindex++;
          if (settings.clickindex == 12)
            settings.clickindex = 0;
          if (this.rtile != 13)
            settings.portalamount++;//console.log(settings.clickindex)
          if (!this.pid) {
            settings.pid++;
            this.pid = settings.pid;
            portal.children[0].innerHTML = this.pid;
          }
          portal.children[1].innerHTML = this.portallink;
          portal.style.display = "block";
          if (settings.backchanged) {
            var bottom = document.getElementById("" + this.id + "bottom");
            bottom.src = settings.lastbackground;
            this.hinter = settings.lastbackground;
          }
          this.istwo = true;
          bild.src = bi;
          top.src = "../Bilder/Map/pfeil.png";
          this.top = top.src.replace(/(http:|https:|[A-Z]:).*\/.*\/(?=Bilder\/.*)/gm, "");
          rotateIt(top, settings.clickindex * 90);
          this.tile = tile_id + settings.clickindex;
          this.istwo = false;
          if (settings.backchanged) {
            var bottom = document.getElementById("" + this.id + "bottom");
            bottom.src = settings.lastbackground;
            this.hinter = settings.lastbackground;
          }
        } /* else if (tile_id >= 17 && tile_id <= 20) {
          if (settings.lastid == this.id)
            settings.clickindex++;
          if (settings.clickindex == 4)
            settings.clickindex = 0;
          //console.log(settings.clickindex)
          if (this.rtile != 13 && this.rtile != 17)
            settings.portalamount++;
          bild.src = bi;
          top.src = "../Bilder/Map/pfeil.png";
          this.top = top.src.replace(/(http:|https:|[A-Z]:).*\/.*\/(?=Bilder\/.*)/gm, "");;
          rotateIt(top, settings.clickindex * 90);
          this.tile = tile_id + settings.clickindex;
          this.istwo = false;
          if (settings.backchanged) {
            var bottom = document.getElementById("" + this.id + "bottom");
            bottom.src = settings.lastbackground;
            this.hinter = settings.lastbackground;
          }
        }*/ else if (tile_id == -1234) {
          var bottom = document.getElementById("" + this.id + "bottom");
          bottom.src = bi;
          settings.lastbackground = bi.replace(/(http:|https:|[A-Z]:).*\/.*\/(?=Bilder\/.*)/gm, "");
          this.hinter = bi.replace(/(http:|https:|[A-Z]:).*\/.*\/(?=Bilder\/.*)/gm, "");;
          gotchanged = true;
        } else if (tile_id == "gen") {
          bild.src = this.image;
          top.src = this.top
          var bottom = document.getElementById("" + this.id + "bottom");
          bottom.src = this.hinter;
          rotateIt(top, (this.tile - this.rtile) * 90);
          if (this.rtile == 13) {
            portal.children[0].innerHTML = this.pid;
            portal.children[1].innerHTML = this.portallink;
            portal.style.display = "block";
          }
          //console.log(this.tile - this.rtile)
        }
        
        if (tile_id != -1234 && tile_id != "gen" && tile_id != "image" && tile_id != "bottom")
          this.rtile = tile_id;
        this.image = bild.src.replace(/(http:|https:|[A-Z]:).*\/.*\/(?=Bilder\/.*)/gm, "")
        settings.lastid = this.id;
        if (gotchanged && (this.rtile != 13) && wasbefore) {
          settings.portalamount--;
          portal.style.display = "none";
        }
        if (tile_id == "image") {
          bild.src = "../" + bi.replace("../", "");
          this.image = "../" +  bi.replace("../", "");
          //console.log("this.image");
        }else if (tile_id == "bottom") {
          //console.log("bottom")
          this.hinter = "../" +  bi.replace("../", "");
          var bottom = document.getElementById("" + this.id + "bottom");
          bottom.src = this.hinter;
        }
      }
    }

    function showportals() {
      //console.log(this.rtile);
      if (this.rtile == 13) {
        //console.log("test");
        document.getElementById("block" + this.id + "").style.display = "none";
      } else {
        document.getElementById("block" + this.id + "").style.display = "block";
      }
    }
    function hideportals() {
      document.getElementById("block" + this.id + "").style.display = "none";
    }
    function portalsall(type = "show") {
      if (type == "show") {
        tiles.forEach(elem => {
          elem.showportals();
        });
      }
      if (type == "background") {
        tiles.forEach(elem => {
          elem.showportals();
        });
      }
      if (type == "hide") {
        tiles.forEach(elem => {
          elem.hideportals();
        });
      }
    }
    function showextras(el) {
      if (settings.portalamount > 1) {
        settings.nextmove = true;
        portalsall("show");
        currentportal = el;
      }
    }
    function hideextras(el) {
      settings.nextmove = false;
      portalsall("hide");
      currentportal = el;
    }
    function tile(id) {
      this.portallink = "unset";
      this.pid = undefined;
      this.toptop = "";
      this.rtile = 0;
      this.tile = 0;
      this.image = "../Bilder/Map/feld2.jpg";
      this.hinter = "../Bilder/Map/feld1.jpg";
      this.id = id;
      this.last = "../Bilder/Map/feld2.jpg";
      this.istwo = false;
      this.showportals = showportals;
      this.hideportals = hideportals;
      this.update = update;
      this.top = "../Bilder/Map/empty.png";
    }

    function tilebyId(tid) {
      var res = "";
      tiles.forEach(element => {
        if (element.id == tid) {
          res = element;
        }

      });
      return res;
    }

    function clix(el, right = false, ev = "") {
      var cont = true;
      if (right)
        event.preventDefault();
      if (el.search("block") == -1)
        if (settings.nextmove && settings.portalamount > 1 && (!shift)) {

          tilebyId(currentportal).portallink = tilebyId(el).pid;
          if (tilebyId(el).portallink == "unset")
          tilebyId(el).portallink = tilebyId(currentportal).pid;
          tilebyId(currentportal).update("gen");
          tilebyId(el).update("gen");
          hideextras(el);
          cont = false;
        }
        else
          if ((settings.selectedinv == 13)) {
          cont = false;
            if (right) {
              if (shift && ((tilebyId(el).rtile == 13))) {
                showextras(el);
              }else
          cont = true;

            } else {
              if (tilebyId(el).rtile != settings.selectedinv) {
                  tilebyId(el).update(settings.selectedinv, settings.selectedstyle);
                showextras(el);
              }
              else
                tilebyId(el).update(settings.selectedinv, settings.selectedstyle);
            }

          }

          if (cont)
          if (right) {
              //console.log("oops")
              event.preventDefault();
              tilebyId(el).update(0, settings.lastbackground);
            } else {
              tilebyId(el).update(settings.selectedinv, settings.selectedstyle);
            }
    }

    function generatemapstring(call = () => { }) {
      var map = "[";
      var all = document.querySelectorAll("#allall .row");
      all.forEach(element => {
        var row = document.querySelectorAll("#allall #" + element.getAttribute("id") + " > div");
        //console.log(row);
        var sub = "[";
        row.forEach(elementb => {
          //console.log(elementb);
          if(tilebyId(elementb.getAttribute("identi")).rtile == 13)
          sub += ("[" + tilebyId(elementb.getAttribute("identi")).tile + ", ['" + tilebyId(elementb
              .getAttribute("identi")).hinter.replace(/.*(?=Bilder.*\....)/gm, "") + "','" + tilebyId(elementb
                .getAttribute("identi")).image.replace(/.*(?=Bilder.*\....)/gm, "") + "']," + tilebyId(elementb.getAttribute("identi")).pid + "," + (tilebyId(elementb.getAttribute("identi")).portallink == "unset" ? tilebyId(elementb.getAttribute("identi")).pid : tilebyId(elementb.getAttribute("identi")).portallink ) + "],");
                else
          if (tilebyId(elementb.getAttribute("identi")).istwo)
            sub += ("[" + tilebyId(elementb.getAttribute("identi")).tile + ", ['" + tilebyId(elementb
              .getAttribute("identi")).hinter.replace(/.*(?=Bilder.*\....)/gm, "") + "','" + tilebyId(elementb
                .getAttribute("identi")).image.replace(/.*(?=Bilder.*\....)/gm, "") + "']],");
          else
            sub += ("[" + tilebyId(elementb.getAttribute("identi")).tile + ", '" + tilebyId(elementb
              .getAttribute("identi")).image.replace(/.*(?=Bilder.*\....)/gm, "") + "'],");
        });
        map += sub + "], \n";
      });
      settings.thismap = map + "]\n";
      takescreenshot();
      getmaps((amount) => {
        setTimeout(function (amount) {


          var allstring = "var geld= " + settings.geld + ";\n";

          allstring += "var map = " + settings.thismap + ";\n";
          allstring += "success= true;\n";
          allstring += "mapSchwie= " + settings.difficulty + ";\n";
          allstring += "MapName = '" + settings.Mapname + "';\n";
          allstring += "multiStartTyp = " + settings.starthandle + ";\n";
          allstring +=
            "if(!mapSchwie) mapSchwie = 'undefined';if(!MapName) MapName = 'undefined';if(!multiStartTyp) multiStartTyp = 'undefined';"

          allstring += "var randomtiles = " + JSON.stringify(settings.randomtiles) +
            "\n\n\n\n \/\/ hier kommt das preview- Bild \n\n\n";
            var imfolder = "map_" + (amount.length + 1) + new Date().getTime() + "Bild";
            allstring += "var image = 'Maps/" + imfolder + "/Bild.png';"
            var im  = document.getElementById("screenshot").getAttribute("src");
          //console.log(document.getElementById("screenshot").getAttribute("src"))
          settings.mapstring = allstring;
          var zip = new JSZip();
          zip.file("map" + (amount.length + 1) + ".js", allstring);
          var img = zip.folder(imfolder);
          img.file("Bild.png", im.substring(22), {base64: true});
          zip.generateAsync({type:"blob"})
                .then(function(content) {
                    // see FileSaver.js
                    //console.log("test");
                    saveAs(content, "map" + (amount.length + 1) + ".mapinstallment");
                });
        }.bind(null, amount), 4000)
      })
    }

    function takescreenshot() {

      getScreenshotOfElement(document.getElementById("allall"), 0, 0, document.getElementById("allall")
        .getBoundingClientRect().width, document.getElementById("allall").getBoundingClientRect().height,
        function (data) {
          document.getElementById("screenshot").setAttribute("src", "data:image/png;base64," + data);
        });
    }

    function resizekoords(x, y) {
      settings.wi = Math.round(window.innerWidth - window.innerWidth * 0.044);
      settings.hei = Math.round(window.innerHeight - window.innerHeight * 0.51);
      //console.log(settings.wi + "," + settings.hei + "," + Math.round(window.innerWidth * 0.044) + "," + (settings.wi > settings.hei / x ? settings.hei / y : settings.wi));
      //(wi > hei / x ? hei / y : wi)
      //wi > hei ? hei / y : wi / x
      return (settings.wi / x > settings.hei / y ? settings.hei / y : settings.wi / x);
      //diese Funktion gibt die richtige Grösse aus
    }
   // /*
        do {
          settings.Xkoordinaten = parseInt(window.prompt("wie viele X-koordinaten soll das Spiel haben?", ""), 10);
        } while (isNaN(settings.Xkoordinaten) || settings.Xkoordinaten > 50 || settings.Xkoordinaten < 5);
        do {
          settings.Ykoordinaten = parseInt(window.prompt("wie viele Y-koordinaten soll das Spiel haben?", ""), 10);
        } while (isNaN(settings.Ykoordinaten) || settings.Ykoordinaten > 50 || settings.Ykoordinaten < 5);
      //  */

    generate(settings.Xkoordinaten, settings.Ykoordinaten);

    function generate(Xkoordinaten, Ykoordinaten) {
      tiles = [];
      document.getElementById("area").innerHTML = "";

      var size = resizekoords(settings.Xkoordinaten, settings.Ykoordinaten);
      //document.body.innerHTML += `<div id=assa style="position:absolute; top:5px; left:5px; width:${settings.wi}px; height:${settings.hei}px; border:4px solid rgba(255,0,0,.5);"></div>`;
      var all = "<div id=allall style='width:" + size * settings.Xkoordinaten + "px; height: " + size * settings
        .Ykoordinaten + "px;'>";
      for (var i = 0; i < settings.Ykoordinaten; i++) {
        all +=
          `<div class="row" id="row${i}" style="height:${size}px; width:${size * settings.Xkoordinaten}px;margin-right:0px;">`
        for (var j = 0; j < settings.Xkoordinaten; j++) {
          all += `<div identi="${i + "," + j}" class=feld style="height:${size}px; width:${size}px;" " >
      <input id=${"a" + i + "," + j} class=tile type="hidden" value=0>
      <input id=${"b" + i + "," + j} class=design type="hidden" value=0>
      <img id=${i + "," + j + "bottom"} class="bottom" src="../Bilder/Map/feld1.jpg" height=${size} width=${size} style="position:absolute; top:0px; left:0px; height:${size}px; width:${size}px;">
      <img id=${i + "," + j} src="../Bilder/Map/feld1.jpg" height=${size} width=${size} style="position:absolute; top:0px; left:0px; height:${size}px; width:${size}px;">
      <img id=${i + "," + j + "top"} class=top src="../Bilder/Map/empty.png" height=${size} width=${size} style="position:absolute; top:0px; left:0px; height:${size}px; width:${size}px;">
      <div id="block${i + "," + j}" class="blockers" style="width:${size}px; height:${size}px; display:none;" width=${size} height=${size} ></div>
        <div id="info${i + "," + j}" class="portinfo" style="width:${size}px; height:${size}px; display:none;" width=${size} height=${size} >
        <div class=left>121</div>
        <div class=right>345</div>
        </div>
      
      </div>`
          tiles.push(new tile(i + "," + j));
        }
        all += "</div>";
      }
      all += "</div>";
      document.getElementById("area").innerHTML = all;
      tiles.forEach(element => {
        element.update(0, "../Bilder/Map/feld1.jpg");
      });
    }

    function rotateIt(image, rotateAngle) {
      var old = image.getAttribute("style").split(";;")
      //console.log(image);
      image.setAttribute("style", old[0] + ";;transform: rotate(" + rotateAngle + "deg)");
      rotateAngle = rotateAngle + 90;
    }

    function convert() {
      var leng = tiles.length;

    }
    getmaps();

    function getmaps(func = (() => { })) {
      mapold = map;
      geldold = settings.geld;
      var script = document.createElement("script");
      script.src = "../Maps/map" + checkerturn +
        `.js?${"?" + new Date().getTime() + Math.floor(Math.random() * 1000000)}`;
      //?"+new Date().getTime()+Math.floor(Math.random()*1000000);
      // eslint-disable-next-line no-//console
      document.body.appendChild(script);
      script.onerror = function (el, func) {
        success = false;
        handle(el, func, (function () {
          success = false;
        })());
      }.bind(null, script, func);
      script.onload = function (el, func) {
        handle(el, func)
      }.bind(null, script, func);
    }
    document.addEventListener("click", function (event) {
      try {
        
        if (JSON.stringify(event.path[1].getAttribute("asl")) == JSON.stringify("aslb")) {
          //do stuff
        } else if (JSON.stringify(event.path[1].getAttribute("asl")) == JSON.stringify("asl")) {
          //do stuff
          var from = document.getElementById("from").src.replace(/(http:|https:|[A-Z]:).*\/.*\/(?=Bilder\/.*)/gm, "").replace("../", "");
          var to = document.getElementById("to").src.replace(/(http:|https:|[A-Z]:).*\/.*\/(?=Bilder\/.*)/gm, "").replace("../", "");

          tiles.forEach(elem => {
            console.log(document.getElementById(elem.id).src.replace(/(http:|https:|[A-Z]:).*\/.*\/(?=Bilder\/.*)/gm, "").replace("../", "") , from);
            if(document.getElementById(elem.id).src.replace(/(http:|https:|[A-Z]:).*\/.*\/(?=Bilder\/.*)/gm, "").replace("../", "") == from){
              settings.selectedstyle = "../" + to;
              elem.update("image","../" + to);
            
            }
            if(elem.hinter.replace("../", "") == from){
              settings.lastbackground = "../" + to;
            elem.update("bottom","../" + to);
            }
        });
        } else if (JSON.stringify(event.path[1].getAttribute("class")) == JSON.stringify("floaties")) {
          //console.log(event.path[2].getAttribute("invno"));
          event.path[2].children[0].children[0].setAttribute("src", event.path[0].getAttribute("src"));
          var c = Array.prototype.slice.call(event.path[1].children);
          c.forEach((el) => {
            el.setAttribute("class", "false")
          });
          event.path[0].setAttribute("class", "true");
          event.path[1].style.display = "none";
        }
else

        if (JSON.stringify(event.path[1].getAttribute("class")) == JSON.stringify("feld")) {
          clix(event.target.id.replace("top", ""));
        } else if (JSON.stringify(event.path[1].getAttribute("class")) == JSON.stringify("inimage")) {
          settings.selectedinv = parseInt(event.path[1].getAttribute("invno"));
          document.querySelectorAll(".inimage").forEach((element) => {
            element.setAttribute("class", "inimage");
            element.setAttribute("style", "");
          });
          event.path[1].setAttribute("class", "inimage selected");
          event.path[1].setAttribute("style", "z-index:10000");
          settings.selectedstyle = event.path[0].getAttribute("src");
        } else if (JSON.stringify(event.path[1].getAttribute("class")) == JSON.stringify("floaties")) {
          settings.selectedinv = parseInt(event.path[2].children[0].getAttribute("invno"));
          //console.log(event.path[2].getAttribute("invno"));
          document.querySelectorAll(".inimage").forEach((element) => {
            element.setAttribute("class", "inimage");
            element.setAttribute("style", "");
          });
          event.path[2].children[0].children[0].setAttribute("src", event.path[0].getAttribute("src"));
          settings.selectedstyle = event.path[0].getAttribute("src");
          var c = Array.prototype.slice.call(event.path[1].children);
          c.forEach((el) => {
            el.setAttribute("class", "false")
          });
          event.path[0].setAttribute("class", "true");
          event.path[1].style.display = "none";
          document.querySelectorAll(".inimage").forEach((element) => {
            element.setAttribute("class", "inimage");
            element.setAttribute("style", "");
          })
          event.path[2].children[0].setAttribute("class", "inimage selected");
          event.path[2].children[0].setAttribute("style", "z-index:10000");
        }

      } catch (Error) {
        console.error(Error);
      }
      document.querySelectorAll(".floaties").forEach((el) => {
        el.style.display = "none";
      })
    });
    document.addEventListener("contextmenu", function (event) {
      try {
        if (JSON.stringify(event.path[1].getAttribute("class")) == JSON.stringify("feld")) {
          //console.log(event.path[1].getAttribute("class")) == JSON.stringify("feld")
          clix(event.target.id.replace("top", ""), true, event);
        } else if (JSON.stringify(event.path[1].getAttribute("class")) == JSON.stringify("inimage") || JSON
          .stringify(event.path[1].getAttribute("class")) == JSON.stringify("inimage selected")) {
          event.path[2].children[1].style.display = "block";
          event.preventDefault();
        }
      } catch (Error) {
        //console.log(Error);
      }
    });
    settings.selectedinv = 0;
    settings.selectedstyle = "../Bilder/Map/feld1.jpg";
    document.getElementById("slider").addEventListener("input", function () {
      settings.opacity = this.value;
      document.getElementById("val").innerHTML = this.value;
      document.querySelectorAll(".top").forEach((element) => {
        element.style.opacity = this.value;
      })
    });

    function dateiauswahl(evt) {
      // FileList-Objekt des input-Elements auslesen, auf dem 
      // das change-Event ausgelöst wurde (event.target)
      var files = evt.target.files;

      // Deklarierung eines Array Objekts mit Namen "fragmente". Hier werden die Bausteine
      // für die erzeugte Listenausgabe gesammelt.
      var fragmente = [];
      // Zählschleife; bei jedem Durchgang den Namen, Typ und 
      // die Dateigröße der ausgewählten Dateien zum Array hinzufügen
      for (var i = 0, f; f = files[i]; i++) {
        fragmente.push('<li><strong>', f.name, '</strong> (', f.type || 'n/a', ') - ',
          f.size, ' bytes</li>');
      }
      if (/.*\.mapfile$/.test(files[0].name)) {
        ismaptrue = true;
        var reader = new FileReader();
        reader.onload = function () {
          dataURL = reader.result;
        };
        reader.readAsText(files[0]);
      } else {
        dataURL = false;
        ismaptrue = false;
      }
      // Alle Fragmente im fragmente Array aneinanderhängen, in eine unsortierte Liste einbetten
      // und das alles als HTML-Inhalt in das output-Elements mit id='dateiListe' einsetzen.
      document.getElementById('dateiListe').innerHTML = '<ul>' + fragmente.join('') + '</ul>';
    }

    // UI-Events erst registrieren wenn das DOM bereit ist!
    document.addEventListener("DOMContentLoaded", function () {
      // Falls neue Eingabe, neuer Aufruf der Auswahlfunktion
      document.getElementById('dateien').addEventListener('change', dateiauswahl, false);
    });

    function convertfromjs() {

    }
    document.addEventListener("keydown", function (event) {
      if (event.key == "Shift")
        shift = true;
    })
    document.addEventListener("keyup", function (event) {

      if (event.key == "Shift")
        shift = false;
    })
  </script>
</body>

</html>