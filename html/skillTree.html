<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Skilltree</title>
    <link rel="stylesheet" href="../css/tuerme_gegner.css">
    <script src="../js/importantFunktions.js"></script>
    <script src="../js/towerGegnerStats.js"></script>
    <script src="../js/skills.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
  </head>
  <body>
    <div class="btn-box">
      <a class="btn" id="reset" href="javascript:">Reset</a>
      <a class="btn" href="../index.html">Back</a>
    </div>
    <div id="tree">
      <h1>Skilltree</h1> <br>
      <h2>Du hast <span id="skillPunkte"></span> skillpunkte</h2> <br>
      <h3>
        Klicke auf einen Turm um seine Werte zu sehen und zu verbessern. <br>
        Klicke auf das Fragezeichen um die Werte aller Türme zu verbessern. <br> <br>
      </h3>
    </div>
    <div id="stats" hidden>
      <img id="close" src="../Bilder/Icons/close.png" alt="">
      <span name="Turmname" id="name"> </span><br>
      <table id="normalStats">
        <tr>
          <td>Damge  <span  name="Damge"></span></td>
          <td name = "kosten"></td>
          <td name = "stufe"></td>
          <td name="buttons">
            <img src="../Bilder/Icons/plusAn.png" name="plus">
            <img src="../Bilder/Icons/minusAn.png" name="minus">
          </td>
        </tr>
        <tr>
          <td>Angriffszeit <span name="Angriffszeit"></span></td>
          <td name = "kosten"></td>
          <td name = "stufe"></td>
          <td name="buttons">
            <img src="../Bilder/Icons/plusAn.png" name="plus">
            <img src="../Bilder/Icons/minusAn.png" name="minus">
          </td>
        </tr>
        <tr>
          <td>Reichweite <span name="Reichweite"></span></td>
          <td name = "kosten"></td>
          <td name = "stufe"></td>
          <td name="buttons">
            <img src="../Bilder/Icons/plusAn.png" name="plus">
            <img src="../Bilder/Icons/minusAn.png" name="minus">
          </td>
        </tr>
        <tr id = "Drehgeschwindigkeit">
          <td>Drehgeschwindigkeit <span name="Drehgeschwindigkeit"></span></td>
          <td name = "kosten"></td>
          <td name = "stufe"></td>
          <td name="buttons">
            <img src="../Bilder/Icons/plusAn.png" name="plus">
            <img src="../Bilder/Icons/minusAn.png" name="minus">
          </td>
        </tr>
        <tr>
          <td>critChance <span name="critChance"></span></td>
          <td name = "kosten"></td>
          <td name = "stufe"></td>
          <td name="buttons">
            <img src="../Bilder/Icons/plusAn.png" name="plus">
            <img src="../Bilder/Icons/minusAn.png" name="minus">
          </td>
        </tr>
        <tr>
          <td>critDamage <span name="critDamage"></span></td>
          <td name = "kosten"></td>
          <td name = "stufe"></td>
          <td name="buttons">
            <img src="../Bilder/Icons/plusAn.png" name="plus">
            <img src="../Bilder/Icons/minusAn.png" name="minus">
          </td>
        </tr>
        <tr id = "EffecktStärke">
          <td></td>
          <td name = "kosten"></td>
          <td name = "stufe"></td>
          <td name="buttons">
            <img src="../Bilder/Icons/plusAn.png" name="plus">
            <img src="../Bilder/Icons/minusAn.png" name="minus">
          </td>
        </tr>
        <tr id = "EffecktDauer">
          <td></td>
          <td name = "kosten"></td>
          <td name = "stufe"></td>
          <td name="buttons">
            <img src="../Bilder/Icons/plusAn.png" name="plus">
            <img src="../Bilder/Icons/minusAn.png" name="minus">
          </td>
        </tr>
        <tr id = "st5">
          <td>Stufe5 unlockt <span name="Stufe5unlockt"></span></td>
          <td name = "kosten"></td>
          <td name = "stufe"></td>
          <td name="buttons">
            <img src="../Bilder/Icons/plusAn.png" name="plus">
            <img src="../Bilder/Icons/minusAn.png" name="minus">
          </td>
        </tr>
        <tr id = "MaxStufe">
          <td>Maximale TurmStufe <span name="MaxStufe"></span></td>
          <td name = "kosten"></td>
          <td name = "stufe"></td>
          <td name="buttons">
            <img src="../Bilder/Icons/plusAn.png" name="plus">
            <img src="../Bilder/Icons/minusAn.png" name="minus">
          </td>
        </tr>
      </table>
      <table id="supportStats">
        <tr>
          <td>Verbesstert den Damage von nahen Türmen um <span class="Effeckt"></span>%</td>
          <td class = "kosten"></td>
          <td class = "stufe"></td>
          <td class="buttons">
            <img src="../Bilder/Icons/plusAn.png" class="plus">
            <img src="../Bilder/Icons/minusAn.png" class="minus">
          </td>
        </tr>
        <tr>
          <td>Effektreichweite: <span class="Reichweite"></span></td>
          <td class = "kosten"></td>
          <td class = "stufe"></td>
          <td class="buttons">
            <img src="../Bilder/Icons/plusAn.png" class="plus">
            <img src="../Bilder/Icons/minusAn.png" class="minus">
          </td>
        </tr>
        <tr>
          <td>Verbesstert die Angriffsgeschwindigkeit von nahen Türmen um <span class="Effeckt"></span>%</td>
          <td class = "kosten"></td>
          <td class = "stufe"></td>
          <td class="buttons">
            <img src="../Bilder/Icons/plusAn.png" class="plus">
            <img src="../Bilder/Icons/minusAn.png" class="minus">
          </td>
        </tr>
        <tr>
          <td>Effektreichweite: <span class="Reichweite"></span></td>
          <td class = "kosten"></td>
          <td class = "stufe"></td>
          <td class="buttons">
            <img src="../Bilder/Icons/plusAn.png" class="plus">
            <img src="../Bilder/Icons/minusAn.png" class="minus">
          </td>
        </tr>
        <tr>
          <td>Verbesstert die Effektstärke, -dauer und -reichweite von nahen Türmen um <span class="Effeckt"></span>%</td>
          <td class = "kosten"></td>
          <td class = "stufe"></td>
          <td class="buttons">
            <img src="../Bilder/Icons/plusAn.png" class="plus">
            <img src="../Bilder/Icons/minusAn.png" class="minus">
          </td>
        </tr>
        <tr>
          <td>Effektreichweite: <span class="Reichweite"></span></td>
          <td class = "kosten"></td>
          <td class = "stufe"></td>
          <td class="buttons">
            <img src="../Bilder/Icons/plusAn.png" class="plus">
            <img src="../Bilder/Icons/minusAn.png" class="minus">
          </td>
        </tr>
        <tr>
          <td>Verbesstert die Drehgeschwindigkeit und Reichweite von nahen Türmen um <span class="Effeckt"></span>%</td>
          <td class = "kosten"></td>
          <td class = "stufe"></td>
          <td class="buttons">
            <img src="../Bilder/Icons/plusAn.png" class="plus">
            <img src="../Bilder/Icons/minusAn.png" class="minus">
          </td>
        </tr>
        <tr>
          <td>Effektreichweite: <span class="Reichweite"></span></td>
          <td class = "kosten"></td>
          <td class = "stufe"></td>
          <td class="buttons">
            <img src="../Bilder/Icons/plusAn.png" class="plus">
            <img src="../Bilder/Icons/minusAn.png" class="minus">
          </td>
        </tr>
        <tr>
          <td>Stufe5 unlockt <span id="Stufe5unlockt"></span></td>
          <td class = "kosten"></td>
          <td class = "stufe"></td>
          <td class="buttons">
            <img src="../Bilder/Icons/plusAn.png" class="plus">
            <img src="../Bilder/Icons/minusAn.png" class="minus">
          </td>
        </tr>
      </table>
    </div>
    <script type="text/javascript">
    document.getElementById("skillPunkte").innerHTML = skillPunkte;
    var selected = -1;
    var strg = false;
    var schwierigkeit = 0;
    for (var i = 0; i < towertypen.length; i++) {
      if (i<10) {
        document.getElementById("tree").innerHTML += '<img id="0' + i + towertypen[i][10] + '" class="Object" src="../' + towertypen[i][1] + '">';
      }
      else {
        document.getElementById("tree").innerHTML += '<img id="' + i + towertypen[i][10] + '" class="Object" src="../' + towertypen[i][1] + '">';
      }
    }
    document.getElementById("reset").addEventListener("click", function functionName() {
      resetSkills();
      document.getElementById("skillPunkte").textContent = skillPunkte;
    });
    for (var i = 0; i < towertypen.length; i++) {
      if (i<10) {
        document.getElementById("0" + i + towertypen[i][10]).addEventListener("click", showStats);
      }
      else {
        document.getElementById(i + towertypen[i][10]).addEventListener("click", showStats);
      }
    }
    for (var i = 0; i < document.getElementsByName("buttons").length; i++) {
      neuerEventlistener(document.getElementsByName("plus")[i], addSkillpunkt, [i, true]);
      neuerEventlistener(document.getElementsByName("minus")[i], addSkillpunkt, [i, false]);
    }
    for (var i = 0; i < document.getElementsByClassName("buttons").length; i++) {
      neuerEventlistener(document.getElementsByClassName("plus")[i], addSkillpunkt, [i, true]);
      neuerEventlistener(document.getElementsByClassName("minus")[i], addSkillpunkt, [i, false]);
    }
    function neuerEventlistener(element, funktion, uebergabewerte) {
      element.addEventListener("click", function(){funktion(uebergabewerte, element);});
    }
    document.getElementById('close').addEventListener("click", close);
    function close() {
      document.getElementById("stats").hidden = true;
    }

    function addSkillpunkt(uebergabewerte, element) {
      typ = uebergabewerte[0];
      plus = uebergabewerte[1];
      if (typ == 9) {
        var nummer = 123;
      }
      else {
        var nummer = typ + 10 * selected;
      }
      if (plus) {
        if (skills[nummer][9] < skills[nummer][8] && skillPunkte >= skills[nummer][10]+skills[nummer][9]) {
          if (haveRequired(nummer)) {   // sind genügend von benötigten skills geskillet
            skillPunkte -= skills[nummer][10]+skills[nummer][9];
            document.getElementById("skillPunkte").innerHTML = skillPunkte;
            skills[nummer][9]++;
            if (strg) {
              addSkillpunkt(uebergabewerte, element);
            }
          }
        }
      }
      else {
        if (skills[nummer][9] > 0) {
          //prüfe ob dadurch requirements nichtmehr erfüllt sind
          skills[nummer][9]--;
          var required = true;
          for (var i = 0; i < skills.length; i++) {
            if (skills[i] != undefined && skills[i][9] > 0 && !haveRequired(i)) {
              required = false;
              break;
            }
          }
          if (required) {
            skillPunkte += skills[nummer][10]+skills[nummer][9];
            document.getElementById("skillPunkte").innerHTML = skillPunkte;
            if (strg) {
              addSkillpunkt(uebergabewerte, element);
            }
          }
          else {
            skills[nummer][9]++;
          }
        }
      }
      var pos = document.getElementById("stats").getBoundingClientRect();
      saveSkillTree();
      applaySkills();
      showStats(false, pos.x-70, pos.y, document.getElementById("stats").id);
    }
    function haveRequired(nummer) {
      if (Array.isArray(skills[nummer][7])) {
        for (var i = 0; i < skills[nummer][7].length; i++) {
          required = skills[nummer][7][i];
          for (var j = 0; j < skills[nummer][6][i].length; j++) {
            required -= skills[skills[nummer][6][i][j]][9];
          }
          if (required > 0) {
            return false;
          }
        }
        return true;
      }
      else {
        var required = skills[nummer][7];   // sind genügend von benötigten skills geskillet
        for (var i = 0; i < skills[nummer][6].length; i++) {
          required -= skills[skills[nummer][6][i]][9];
        }
        if (required <= 0) {
          return true;
        }
        else {
          return false;
        }
      }
    }
    function showStats(useThis = false, x = 0, y = 0, id = "") {
      if (useThis) {
        var pos = this.getBoundingClientRect();
        x = pos.x;
        y = pos.y;
        id = this.id;
        var towerTyp = id.substr(0,2)*1;
        selected = towerTyp;
      }
      else {
        var towerTyp = selected;
      }
      document.getElementById("stats").hidden = false;
      document.getElementById("normalStats").hidden = false;
      document.getElementById("supportStats").hidden = true;
      if (towerTyp == 11) {
        document.getElementsByName("Turmname")[0].innerHTML = "Stats für alle Türme";
        document.getElementsByName("Damge")[0].innerHTML = "+" + round(skills[110][4]*skills[110][9], 2)+"%";
        document.getElementsByName("critChance")[0].innerHTML = "+" + round(skills[114][4]*skills[114][9], 2)+"%";
        document.getElementsByName("critDamage")[0].innerHTML = "+" + round(skills[115][4]*skills[115][9], 2)+"%";
        document.getElementsByName("Angriffszeit")[0].innerHTML = round(skills[111][4]*skills[111][9], 2)+"%";
        document.getElementsByName("Reichweite")[0].innerHTML = "+" + round(skills[112][4]*skills[112][9], 2)+"%";
        document.getElementsByName("Drehgeschwindigkeit")[0].innerHTML = "+" + round(skills[113][4]*skills[113][9], 2)+"%";
        document.getElementById('EffecktStärke').hidden = false;
        document.getElementById('EffecktDauer').hidden = false;
        document.getElementById('EffecktStärke').childNodes[1].innerHTML = "EffecktStärke +" + round(skills[116][4]*skills[116][9], 2)+"%";
        document.getElementById('EffecktDauer').childNodes[1].innerHTML = "EffektDauer/EffecktReichweite +" + round(skills[117][4]*skills[117][9], 2)+"%";
        document.getElementById('st5').hidden = true;
        document.getElementById('MaxStufe').hidden = false;
        document.getElementsByName('MaxStufe')[0].innerHTML = skills[123][9]+3;
      }
      else if (towerTyp == 9) {
        document.getElementById("normalStats").hidden = true;
        document.getElementById("supportStats").hidden = false;
        document.getElementsByName("Turmname")[0].textContent = towertypen[towerTyp][10];
        for (var i = 0; i < towertypen[towerTyp][7].length; i++) {
          document.getElementsByClassName("Effeckt")[i].textContent = round(towertypen[towerTyp][8][i], 3);
          document.getElementsByClassName("Reichweite")[i].textContent = round(towertypen[towerTyp][9][i], 3);
        }
        for (var i = 0; i < document.getElementsByClassName("buttons").length; i++) {
          var nummer = i + 10 * selected;
          if (skills[nummer] == undefined) {
            document.getElementsByClassName("buttons")[i].hidden = true;
            document.getElementsByClassName("kosten")[i].hidden = true;
            document.getElementsByClassName("stufe")[i].hidden = true;
          }
          else {
            document.getElementsByClassName("buttons")[i].hidden = false;
            document.getElementsByClassName("kosten")[i].hidden = false;
            document.getElementsByClassName("stufe")[i].hidden = false;
            document.getElementsByClassName("kosten")[i].innerHTML = `Kosten: ${skills[nummer][10]+Math.min(skills[nummer][9], skills[nummer][8]-1)}`;
            document.getElementsByClassName("stufe")[i].innerHTML = `Stufe: ${skills[nummer][9]}/${skills[nummer][8]}`;
            if (skills[nummer][9] < skills[nummer][8] && skillPunkte >= skills[nummer][10]+skills[nummer][9] && haveRequired(nummer)) {
              document.getElementsByClassName("plus")[i].src = "../Bilder/Icons/plusAn.png";
            }
            else {
              document.getElementsByClassName("plus")[i].src = "../Bilder/Icons/plusAus.png";
            }
            if (skills[nummer][9] > 0) {
              skills[nummer][9]--;
              required = true;
              for (var j = 0; j < skills.length; j++) {
                if (skills[j] != undefined && skills[j][9] > 0 && !haveRequired(j)) {
                  required = false;
                  break;
                }
              }
              skills[nummer][9]++;
              if (required) {
                document.getElementsByClassName("minus")[i].src = "../Bilder/Icons/minusAn.png";
              }
              else {
                document.getElementsByClassName("minus")[i].src = "../Bilder/Icons/minusAus.png";
              }
            }
            else {
              document.getElementsByClassName("minus")[i].src = "../Bilder/Icons/minusAus.png";
            }
          }
        }
      }
      else {
        document.getElementsByName("Turmname")[0].innerHTML = towertypen[towerTyp][10];
        document.getElementsByName("Damge")[0].innerHTML = round(towertypen[towerTyp][2], 2);
        document.getElementsByName("critChance")[0].innerHTML = round(towertypen[towerTyp][13], 2) + "%";
        document.getElementsByName("critDamage")[0].innerHTML = round(towertypen[towerTyp][14], 2) + "%";
        document.getElementsByName("Angriffszeit")[0].innerHTML = round(towertypen[towerTyp][5], 4) + "sec";
        document.getElementsByName("Reichweite")[0].innerHTML = round(towertypen[towerTyp][4], 2);
        document.getElementsByName("Drehgeschwindigkeit")[0].innerHTML = round(towertypen[towerTyp][3]*100, 2) + " Grad/sec";
        if (towertypen[towerTyp][7].length == 0) {
          document.getElementById('EffecktStärke').hidden = true;
          document.getElementById('EffecktDauer').hidden = true;
        }
        else {
          document.getElementById('EffecktStärke').hidden = false;
          document.getElementById('EffecktDauer').hidden = false;
          var obj = document.getElementById('EffecktStärke').childNodes[1];
          obj.innerHTML = "";
          for (var i = 0; i < towertypen[towerTyp][7].length; i++) {
            switch (towertypen[towerTyp][7][i]) {
              case 0:
                obj.innerHTML += "Verlangsamt Gegner auf die " + round(1 / (towertypen[towerTyp][8][i] + 1), 4) + " fache Geschwindigkeit <br>";
                break;
              case 1:
                obj.innerHTML += "Stunned Gegner <br>";
                break;
              case 2:
                obj.innerHTML += "Verbrennt Gegner für " + round(towertypen[towerTyp][8][i], 2) + " Schaden/sec <br>";
                break;
              case 3:
                obj.innerHTML += "Vergiftet Gegner für " + round(towertypen[towerTyp][8][i], 2) + " Schaden/sec <br>";
                break;
              case 5:
                obj.innerHTML += "Trifft nahe Gegner zusätzlich für " + round(towertypen[towerTyp][8][i], 2) + " Schaden <br>";
                break;
              case 6:
                obj.innerHTML += "Springt zusätzlich bis zu " + towertypen[towerTyp][8][i] + " mal auf nahe Gegner über <br>";
                break;
            }
          }
          obj = document.getElementById('EffecktDauer').childNodes[1];
          obj.innerHTML = "";
          if (towertypen[towerTyp][7].length > 1) {
            for (var i = 0; i < towertypen[towerTyp][7].length; i++) {
              if (towertypen[towerTyp][7][i] >= 5 && towertypen[towerTyp][7][i] <= 9) {
                obj.innerHTML += "Effektreichweite Effeckt " + (i+1) + ": " + round(towertypen[towerTyp][9][i], 2) + " <br>";
              }
              else {
                obj.innerHTML += "Effektdauer: Effeckt " + (i+1) + ": " + round(towertypen[towerTyp][9][i], 2) + "sec <br>";
              }
            }
          }
          else {
            if (towertypen[towerTyp][7][0] >= 5 && towertypen[towerTyp][7][0] <= 9) {
              obj.innerHTML += "Effektreichweite: " + round(towertypen[towerTyp][9][0], 2) + " <br>";
            }
            else {
              obj.innerHTML += "Effektdauer: " + round(towertypen[towerTyp][9][0], 2) + "sec <br>";
            }
          }
        }
        document.getElementById('st5').hidden = false;
        document.getElementById('MaxStufe').hidden = true;
        document.getElementsByName("Stufe5unlockt")[0].innerHTML = towertypen[towerTyp][12];
      }
      for (var i = 0; i < document.getElementsByName("buttons").length; i++) {
        if (i == 9) {
          var nummer = 123;
        }
        else {
          var nummer = i + 10 * selected;
        }
        if (skills[nummer] == undefined) {
          document.getElementsByName("buttons")[i].hidden = true;
          document.getElementsByName("kosten")[i].hidden = true;
          document.getElementsByName("stufe")[i].hidden = true;
        }
        else {
          document.getElementsByName("buttons")[i].hidden = false;
          document.getElementsByName("kosten")[i].hidden = false;
          document.getElementsByName("stufe")[i].hidden = false;
          document.getElementsByName("kosten")[i].innerHTML = `Kosten: ${skills[nummer][10]+Math.min(skills[nummer][9], skills[nummer][8]-1)}`;
          document.getElementsByName("stufe")[i].innerHTML = `Stufe: ${skills[nummer][9]}/${skills[nummer][8]}`;
          if (skills[nummer][9] < skills[nummer][8] && skillPunkte >= skills[nummer][10]+skills[nummer][9] && haveRequired(nummer)) {
            document.getElementsByName("plus")[i].src = "../Bilder/Icons/plusAn.png";
          }
          else {
            document.getElementsByName("plus")[i].src = "../Bilder/Icons/plusAus.png";
          }
          if (skills[nummer][9] > 0) {
            skills[nummer][9]--;
            required = true;
            for (var j = 0; j < skills.length; j++) {
              if (skills[j] != undefined && skills[j][9] > 0 && !haveRequired(j)) {
                required = false;
                break;
              }
            }
            skills[nummer][9]++;
            if (required) {
              document.getElementsByName("minus")[i].src = "../Bilder/Icons/minusAn.png";
            }
            else {
              document.getElementsByName("minus")[i].src = "../Bilder/Icons/minusAus.png";
            }
          }
          else {
            document.getElementsByName("minus")[i].src = "../Bilder/Icons/minusAus.png";
          }
        }
      }
      if (useThis) {
        document.getElementById("stats").style.top = '0px';
        document.getElementById("stats").style.left = '0px';
        document.getElementById("stats").style.bottom = "auto";
        document.getElementById("stats").style.right = "auto";
        if (x + document.getElementById("stats").offsetWidth >= window.innerWidth * 0.98) {
          if (document.getElementById("stats").offsetWidth < window.innerWidth * 0.96 - 70) {
            document.getElementById("stats").style.left = x - document.getElementById("stats").offsetWidth + 'px';
            document.getElementById("stats").style.right = "auto";
          }
          else {
            document.getElementById("stats").style.right = '0px';
            document.getElementById("stats").style.left = "auto";
          }
        }
        else {
          document.getElementById("stats").style.left = x + 70 + 'px';
          document.getElementById("stats").style.right = "auto";
        }

        if (y + document.getElementById("stats").offsetHeight >= window.innerHeight * 0.98) {
          document.getElementById("stats").style.bottom = '0px';
          document.getElementById("stats").style.top = "auto";
        }
        else {
          document.getElementById("stats").style.top = y + 'px';
          document.getElementById("stats").style.bottom = "auto";
        }
      }
    }
    //frägt ab ob eine Tastatur Taste gedückt oder losgelassen wird
    document.querySelector("body").addEventListener("keydown", tasteGedrueckt);
    document.querySelector("body").addEventListener("keyup", tasteLosgelassen);

    function tasteGedrueckt(evt) {
      switch (evt.key) {
        case "Control":
          strg = true;
          break;
        case "Escape":
          document.getElementById("stats").hidden = true;
          break;
      }
    }
    function tasteLosgelassen(evt) {
      switch (evt.key) {
        case "Control":
          strg = false;
          break;
      }
    }
    </script>
  </body>
</html>
